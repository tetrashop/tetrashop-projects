<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â™Ÿï¸ Ø´Ø·Ø±Ø¬Ø¯ TetraShop - Ù…ÙˆØªÙˆØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #4A44C6;
            --success: #36D1DC;
            --warning: #FFD93D;
            --danger: #FF6B6B;
            --dark: #1A1A2E;
            --light: #F8F9FA;
            --chess-light: #f0d9b5;
            --chess-dark: #b58863;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark) 0%, #16213E 100%);
            color: var(--light);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 3.5rem;
            background: linear-gradient(90deg, var(--success), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            text-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .chess-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .chess-board-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1/1;
            margin: 0 auto;
            border: 12px solid var(--chess-dark);
            border-radius: 8px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
        }
        
        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }
        
        .square.light {
            background-color: var(--chess-light);
        }
        
        .square.dark {
            background-color: var(--chess-dark);
        }
        
        .square.selected {
            box-shadow: inset 0 0 0 3px var(--success);
        }
        
        .square.legal-move::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(54, 209, 220, 0.3);
            border-radius: 50%;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.07);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-size: 1.6rem;
            color: var(--success);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success), #1E90FF);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, var(--warning), #FF9F1C);
            color: var(--dark);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        
        .difficulty-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .difficulty-btn.active {
            background: var(--primary);
            border-color: var(--success);
        }
        
        .game-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .moves-list {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .move-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            background: rgba(54, 209, 220, 0.2);
            color: var(--success);
            border-radius: 15px;
            font-weight: bold;
            margin: 5px;
            font-size: 0.9rem;
        }
        
        .analysis-panel {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
        }
        
        .progress-bar {
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 5px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            opacity: 0.8;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>â™Ÿï¸ Ø´Ø·Ø±Ø¬Ø¯ TetraShop</h1>
            <p class="subtitle">Ù…ÙˆØªÙˆØ± Ø´Ø·Ø±Ø¬Ø¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ - ØªÙˆØ³Ø¹Ù‡â€ŒÛŒØ§ÙØªÙ‡ ØªÙˆØ³Ø· TetraShop</p>
            <div id="server-status">
                <span class="status-badge">ğŸŸ¢ Ø³Ø±ÙˆØ± ÙØ¹Ø§Ù„</span>
                <span class="status-badge" id="current-port">Ù¾ÙˆØ±Øª: 7555</span>
                <span class="status-badge" id="game-status">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø§Ø²ÛŒ</span>
            </div>
        </header>
        
        <div class="main-content">
            <div class="chess-section">
                <h2 class="section-title">ğŸ® ØªØ®ØªÙ‡ Ø´Ø·Ø±Ø¬Ø¯ Ø²Ù†Ø¯Ù‡</h2>
                <div class="chess-board-container">
                    <div class="chess-board" id="chess-board">
                        <!-- ØªØ®ØªÙ‡ Ø¨Ø§ JavaScript Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="newGame()">
                        <span>ğŸ†•</span> Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯
                    </button>
                    <button class="btn btn-success" onclick="engineMove()">
                        <span>ğŸ¤–</span> Ø­Ø±Ú©Øª Ù…ÙˆØªÙˆØ±
                    </button>
                    <button class="btn btn-warning" onclick="analyzePosition()">
                        <span>ğŸ”</span> ØªØ­Ù„ÛŒÙ„ Ù…ÙˆÙ‚Ø¹ÛŒØª
                    </button>
                    <button class="btn" onclick="flipBoard()" style="background: rgba(255,255,255,0.1); color: white;">
                        <span>ğŸ”„</span> Ú†Ø±Ø®Ø´ ØªØ®ØªÙ‡
                    </button>
                </div>
            </div>
            
            <div class="control-panel">
                <h2 class="section-title">âš™ï¸ Ú©Ù†ØªØ±Ù„ Ø¨Ø§Ø²ÛŒ</h2>
                
                <h3 class="section-title" style="font-size: 1.3rem;">ğŸ“Š Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ</h3>
                <div class="difficulty-selector">
                    <div class="difficulty-btn active" data-level="beginner" onclick="setDifficulty('beginner')">
                        Ù…Ø¨ØªØ¯ÛŒ
                    </div>
                    <div class="difficulty-btn" data-level="intermediate" onclick="setDifficulty('intermediate')">
                        Ù…ØªÙˆØ³Ø·
                    </div>
                    <div class="difficulty-btn" data-level="advanced" onclick="setDifficulty('advanced')">
                        Ù¾ÛŒØ´Ø±ÙØªÙ‡
                    </div>
                    <div class="difficulty-btn" data-level="expert" onclick="setDifficulty('expert')">
                        Ø§Ø³ØªØ§Ø¯
                    </div>
                </div>
                
                <div class="game-info">
                    <h3 class="section-title" style="font-size: 1.3rem;">ğŸ“ˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²ÛŒ</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span>ğŸ¯ Ø³Ø·Ø­:</span>
                            <span id="current-level">Ù…ØªÙˆØ³Ø·</span>
                        </div>
                        <div class="info-item">
                            <span>â™Ÿï¸ Ù†ÙˆØ¨Øª:</span>
                            <span id="current-turn">Ø³ÙÛŒØ¯</span>
                        </div>
                        <div class="info-item">
                            <span>ğŸ“Š Ø­Ø±Ú©Ø§Øª:</span>
                            <span id="move-count">0</span>
                        </div>
                        <div class="info-item">
                            <span>âš–ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ:</span>
                            <span id="position-eval">+0.0</span>
                        </div>
                    </div>
                </div>
                
                <div class="moves-list">
                    <h3 class="section-title" style="font-size: 1.3rem; margin-bottom: 10px;">ğŸ“ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø­Ø±Ú©Ø§Øª</h3>
                    <div id="moves-container">
                        <!-- Ø­Ø±Ú©Ø§Øª Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="analysis-panel">
            <h2 class="section-title">ğŸ” ØªØ­Ù„ÛŒÙ„ Ù…ÙˆÙ‚Ø¹ÛŒØª</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span>Ø¨Ù‡ØªØ±ÛŒÙ† Ø­Ø±Ú©Øª:</span>
                    <span id="best-move">e2e4</span>
                </div>
                <div class="info-item">
                    <span>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ:</span>
                    <span id="analysis-eval">+0.3</span>
                </div>
                <div class="info-item">
                    <span>Ø¹Ù…Ù‚ ØªØ­Ù„ÛŒÙ„:</span>
                    <span id="analysis-depth">12</span>
                </div>
                <div class="info-item">
                    <span>Ú¯Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡:</span>
                    <span id="analysis-nodes">250k</span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 60%;"></div>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <button class="btn btn-success" onclick="getDeepAnalysis()" style="padding: 10px 20px;">
                    <span>ğŸ§ </span> ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚
                </button>
            </div>
        </div>
        
        <footer>
            <p>â™Ÿï¸ Ù…ÙˆØªÙˆØ± Ø´Ø·Ø±Ø¬Ø¯ TetraShop v1.0 - ØªÙˆØ³Ø¹Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· TetraShop Projects</p>
            <p>ğŸŒ Ù¾ÙˆØ±Øª Ø³Ø±ÙˆØ±: <strong id="port-display">7555</strong> | ğŸ•’ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="update-time">Ø§Ú©Ù†ÙˆÙ†</span></p>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="showAPIDocs()" style="background: rgba(255,255,255,0.1); color: white; margin: 5px;">
                    ğŸ“– Ù…Ø³ØªÙ†Ø¯Ø§Øª API
                </button>
                <button class="btn" onclick="testEngine()" style="background: rgba(255,255,255,0.1); color: white; margin: 5px;">
                    ğŸ§ª ØªØ³Øª Ù…ÙˆØªÙˆØ±
                </button>
            </div>
        </footer>
    </div>
    
    <script>
        // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
        let gameState = {
            board: [],
            selectedSquare: null,
            legalMoves: [],
            isWhiteTurn: true,
            moves: [],
            difficulty: 'intermediate',
            gameId: null,
            isBoardFlipped: false
        };
        
        // Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§
        const pieces = {
            'r': 'â™œ', 'n': 'â™', 'b': 'â™', 'q': 'â™›', 'k': 'â™š', 'p': 'â™Ÿ',
            'R': 'â™–', 'N': 'â™˜', 'B': 'â™—', 'Q': 'â™•', 'K': 'â™”', 'P': 'â™™'
        };
        
        // Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§
        const pieceNames = {
            'r': 'Ø±Ø® Ø³ÛŒØ§Ù‡', 'n': 'Ø§Ø³Ø¨ Ø³ÛŒØ§Ù‡', 'b': 'ÙÛŒÙ„ Ø³ÛŒØ§Ù‡', 'q': 'ÙˆØ²ÛŒØ± Ø³ÛŒØ§Ù‡', 'k': 'Ø´Ø§Ù‡ Ø³ÛŒØ§Ù‡', 'p': 'Ø³Ø±Ø¨Ø§Ø² Ø³ÛŒØ§Ù‡',
            'R': 'Ø±Ø® Ø³ÙÛŒØ¯', 'N': 'Ø§Ø³Ø¨ Ø³ÙÛŒØ¯', 'B': 'ÙÛŒÙ„ Ø³ÙÛŒØ¯', 'Q': 'ÙˆØ²ÛŒØ± Ø³ÙÛŒØ¯', 'K': 'Ø´Ø§Ù‡ Ø³ÙÛŒØ¯', 'P': 'Ø³Ø±Ø¨Ø§Ø² Ø³ÙÛŒØ¯'
        };
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        async function init() {
            await checkServerStatus();
            createBoard();
            await newGame();
            updateGameInfo();
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('current-port').textContent = `Ù¾ÙˆØ±Øª: ${data.port}`;
                document.getElementById('port-display').textContent = data.port;
                document.getElementById('server-status').innerHTML = `
                    <span class="status-badge">ğŸŸ¢ Ø³Ø±ÙˆØ± ÙØ¹Ø§Ù„</span>
                    <span class="status-badge">Ù¾ÙˆØ±Øª: ${data.port}</span>
                    <span class="status-badge">${data.engine}</span>
                `;
                
                return true;
            } catch (error) {
                showError('Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø³Ø±ÙˆØ± Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡ Ø§Ø³Øª.');
                return false;
            }
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ ØªØ®ØªÙ‡ Ø´Ø·Ø±Ø¬Ø¯
        function createBoard() {
            const boardElement = document.getElementById('chess-board');
            boardElement.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    square.dataset.row = row;
                    square.dataset.col = col;
                    square.addEventListener('click', () => handleSquareClick(row, col));
                    boardElement.appendChild(square);
                }
            }
        }
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ FEN Ø¨Ù‡ ØªØ®ØªÙ‡
        function loadFEN(fen) {
            const board = [];
            const rows = fen.split(' ')[0].split('/');
            
            for (let row = 0; row < 8; row++) {
                const boardRow = [];
                const fenRow = rows[row];
                let colIndex = 0;
                
                for (let char of fenRow) {
                    if (isNaN(char)) {
                        boardRow.push(char);
                        colIndex++;
                    } else {
                        for (let i = 0; i < parseInt(char); i++) {
                            boardRow.push(null);
                            colIndex++;
                        }
                    }
                }
                board.push(boardRow);
            }
            
            gameState.board = board;
            updateBoardDisplay();
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªØ®ØªÙ‡
        function updateBoardDisplay() {
            const squares = document.querySelectorAll('.square');
            
            squares.forEach(square => {
                square.textContent = '';
                square.classList.remove('selected', 'legal-move');
                
                const row = parseInt(square.dataset.row);
                const col = parseInt(square.dataset.col);
                
                const piece = gameState.board[row][col];
                if (piece) {
                    square.textContent = pieces[piece] || piece;
                }
            });
        }
        
        // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù…Ø±Ø¨Ø¹
        function handleSquareClick(row, col) {
            const piece = gameState.board[row][col];
            
            // Ø§Ú¯Ø± Ù…Ø±Ø¨Ø¹ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
            if (gameState.selectedSquare) {
                const move = gameState.legalMoves.find(m => 
                    m.to.row === row && m.to.col === col
                );
                
                if (move) {
                    makeMove(move);
                }
                
                clearSelection();
            } else if (piece) {
                // Ø§Ú¯Ø± Ù…Ù‡Ø±Ù‡ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù† ÙØ¹Ù„ÛŒ Ø§Ø³Øª
                const isWhitePiece = piece === piece.toUpperCase();
                if ((gameState.isWhiteTurn && isWhitePiece) || (!gameState.isWhiteTurn && !isWhitePiece)) {
                    selectSquare(row, col);
                }
            }
        }
        
        // Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø±Ø¨Ø¹
        function selectSquare(row, col) {
            clearSelection();
            
            gameState.selectedSquare = { row, col };
            document.querySelector(`[data-row="${row}"][data-col="${col}"]`).classList.add('selected');
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø±Ú©Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÛŒ (Ø³Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡)
            gameState.legalMoves = calculateLegalMoves(row, col);
            highlightLegalMoves();
        }
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø±Ú©Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÛŒ (Ø³Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡)
        function calculateLegalMoves(row, col) {
            const moves = [];
            const piece = gameState.board[row][col];
            if (!piece) return moves;
            
            const isWhite = piece === piece.toUpperCase();
            
            // Ø­Ø±Ú©Ø§Øª Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
            const directions = [];
            
            switch (piece.toLowerCase()) {
                case 'p': // Ø³Ø±Ø¨Ø§Ø²
                    const dir = isWhite ? -1 : 1;
                    if (isValidSquare(row + dir, col) && !gameState.board[row + dir][col]) {
                        moves.push({from: {row, col}, to: {row: row + dir, col}});
                    }
                    break;
                    
                case 'n': // Ø§Ø³Ø¨
                    const knightMoves = [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];
                    knightMoves.forEach(([dr, dc]) => {
                        const newRow = row + dr;
                        const newCol = col + dc;
                        if (isValidSquare(newRow, newCol)) {
                            const target = gameState.board[newRow][newCol];
                            if (!target || (isWhite && target === target.toLowerCase()) || (!isWhite && target === target.toUpperCase())) {
                                moves.push({from: {row, col}, to: {row: newRow, col: newCol}});
                            }
                        }
                    });
                    break;
                    
                case 'k': // Ø´Ø§Ù‡
                    const kingMoves = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
                    kingMoves.forEach(([dr, dc]) => {
                        const newRow = row + dr;
                        const newCol = col + dc;
                        if (isValidSquare(newRow, newCol)) {
                            const target = gameState.board[newRow][newCol];
                            if (!target || (isWhite && target === target.toLowerCase()) || (!isWhite && target === target.toUpperCase())) {
                                moves.push({from: {row, col}, to: {row: newRow, col: newCol}});
                            }
                        }
                    });
                    break;
            }
            
            return moves;
        }
        
        // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø­Ø±Ú©Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÛŒ
        function highlightLegalMoves() {
            gameState.legalMoves.forEach(move => {
                const square = document.querySelector(`[data-row="${move.to.row}"][data-col="${move.to.col}"]`);
                if (square) {
                    square.classList.add('legal-move');
                }
            });
        }
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨
        function clearSelection() {
            gameState.selectedSquare = null;
            gameState.legalMoves = [];
            document.querySelectorAll('.square').forEach(sq => {
                sq.classList.remove('selected', 'legal-move');
            });
        }
        
        // Ø§Ù†Ø¬Ø§Ù… Ø­Ø±Ú©Øª
        async function makeMove(move) {
            const moveUCI = moveToUCI(move);
            
            try {
                const response = await fetch('/api/engine/move?fen=' + encodeURIComponent(generateFEN()) + '&level=' + gameState.difficulty);
                const data = await response.json();
                
                // Ø­Ø±Ú©Øª Ø¨Ø§Ø²ÛŒÚ©Ù†
                gameState.board[move.to.row][move.to.col] = gameState.board[move.from.row][move.from.col];
                gameState.board[move.from.row][move.from.col] = null;
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø­Ø±Ú©Øª Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
                gameState.moves.push({
                    move: moveUCI,
                    player: gameState.isWhiteTurn ? 'Ø³ÙÛŒØ¯' : 'Ø³ÛŒØ§Ù‡',
                    eval: data.evaluation
                });
                
                gameState.isWhiteTurn = !gameState.isWhiteTurn;
                updateBoardDisplay();
                updateGameInfo();
                
                // Ø­Ø±Ú©Øª Ù…ÙˆØªÙˆØ±
                setTimeout(async () => {
                    await engineMove();
                }, 500);
                
            } catch (error) {
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø­Ø±Ú©Øª: ' + error.message);
            }
        }
        
        // Ø­Ø±Ú©Øª Ù…ÙˆØªÙˆØ±
        async function engineMove() {
            try {
                const fen = generateFEN();
                const response = await fetch('/api/engine/move?fen=' + encodeURIComponent(fen) + '&level=' + gameState.difficulty);
                const data = await response.json();
                
                if (data.success && data.move) {
                    const move = uciToMove(data.move);
                    
                    // Ø§Ø¬Ø±Ø§ÛŒ Ø­Ø±Ú©Øª Ù…ÙˆØªÙˆØ±
                    gameState.board[move.to.row][move.to.col] = gameState.board[move.from.row][move.from.col];
                    gameState.board[move.from.row][move.from.col] = null;
                    
                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
                    gameState.moves.push({
                        move: data.move,
                        player: gameState.isWhiteTurn ? 'Ø³ÙÛŒØ¯' : 'Ø³ÛŒØ§Ù‡',
                        eval: data.evaluation
                    });
                    
                    gameState.isWhiteTurn = !gameState.isWhiteTurn;
                    updateBoardDisplay();
                    updateGameInfo();
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ­Ù„ÛŒÙ„
                    document.getElementById('best-move').textContent = data.move;
                    document.getElementById('analysis-eval').textContent = data.evaluation > 0 ? '+' + data.evaluation.toFixed(1) : data.evaluation.toFixed(1);
                    document.getElementById('analysis-depth').textContent = data.depth;
                    document.getElementById('analysis-nodes').textContent = formatNumber(data.nodes);
                    
                    showToast(`ğŸ¤– Ù…ÙˆØªÙˆØ± Ø­Ø±Ú©Øª Ú©Ø±Ø¯: ${data.move} (Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ: ${data.evaluation.toFixed(1)})`, 'success');
                }
            } catch (error) {
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø­Ø±Ú©Øª Ù…ÙˆØªÙˆØ±: ' + error.message);
            }
        }
        
        // Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯
        async function newGame() {
            try {
                const response = await fetch('/api/game/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ difficulty: gameState.difficulty, playerName: 'Ø¨Ø§Ø²ÛŒÚ©Ù†' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    gameState.gameId = data.gameId;
                    loadFEN(data.fen);
                    gameState.moves = [];
                    gameState.isWhiteTurn = true;
                    
                    updateGameInfo();
                    showToast('ğŸ® Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ø´Ø¯!', 'success');
                }
            } catch (error) {
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯: ' + error.message);
                // Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†
                loadFEN('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR');
                gameState.moves = [];
                gameState.isWhiteTurn = true;
                updateGameInfo();
            }
        }
        
        // ØªØ­Ù„ÛŒÙ„ Ù…ÙˆÙ‚Ø¹ÛŒØª
        async function analyzePosition() {
            try {
                const fen = generateFEN();
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fen: fen, depth: 15 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`ğŸ” ØªØ­Ù„ÛŒÙ„ Ù…ÙˆÙ‚Ø¹ÛŒØª: ${data.bestMove} (Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ: ${data.evaluation})`, 'info');
                    
                    document.getElementById('best-move').textContent = data.bestMove;
                    document.getElementById('analysis-eval').textContent = data.evaluation > 0 ? '+' + data.evaluation.toFixed(1) : data.evaluation.toFixed(1);
                    document.getElementById('analysis-depth').textContent = data.depth;
                    document.getElementById('analysis-nodes').textContent = formatNumber(data.nodes);
                }
            } catch (error) {
                showError('Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ù…ÙˆÙ‚Ø¹ÛŒØª: ' + error.message);
            }
        }
        
        // ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚
        async function getDeepAnalysis() {
            showToast('ğŸ§  Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚ Ù…ÙˆÙ‚Ø¹ÛŒØª...', 'info');
            
            try {
                const fen = generateFEN();
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fen: fen, depth: 20 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let analysisText = `ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚:\n`;
                    analysisText += `Ø¨Ù‡ØªØ±ÛŒÙ† Ø­Ø±Ú©Øª: ${data.bestMove}\n`;
                    analysisText += `Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ: ${data.evaluation > 0 ? '+' + data.evaluation.toFixed(2) : data.evaluation.toFixed(2)}\n`;
                    analysisText += `Ø¹Ù…Ù‚: ${data.depth}\n`;
                    analysisText += `Ú¯Ø±Ù‡â€ŒÙ‡Ø§: ${formatNumber(data.nodes)}\n`;
                    analysisText += `Ø²Ù…Ø§Ù†: ${data.time.toFixed(2)} Ø«Ø§Ù†ÛŒÙ‡`;
                    
                    alert(analysisText);
                }
            } catch (error) {
                showError('Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚: ' + error.message);
            }
        }
        
        // Ú†Ø±Ø®Ø´ ØªØ®ØªÙ‡
        function flipBoard() {
            gameState.isBoardFlipped = !gameState.isBoardFlipped;
            
            const squares = document.querySelectorAll('.square');
            squares.forEach(square => {
                const row = parseInt(square.dataset.row);
                const col = parseInt(square.dataset.col);
                
                if (gameState.isBoardFlipped) {
                    square.dataset.displayRow = 7 - row;
                    square.dataset.displayCol = 7 - col;
                } else {
                    delete square.dataset.displayRow;
                    delete square.dataset.displayCol;
                }
            });
            
            showToast(gameState.isBoardFlipped ? 'ØªØ®ØªÙ‡ Ú†Ø±Ø®Ø§Ù†Ø¯Ù‡ Ø´Ø¯' : 'ØªØ®ØªÙ‡ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ Ø¨Ø±Ú¯Ø´Øª', 'info');
        }
        
        // ØªÙ†Ø¸ÛŒÙ… Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ
        function setDifficulty(level) {
            gameState.difficulty = level;
            
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('active');
            
            const levelNames = {
                beginner: 'Ù…Ø¨ØªØ¯ÛŒ',
                intermediate: 'Ù…ØªÙˆØ³Ø·',
                advanced: 'Ù¾ÛŒØ´Ø±ÙØªÙ‡',
                expert: 'Ø§Ø³ØªØ§Ø¯'
            };
            
            document.getElementById('current-level').textContent = levelNames[level];
            showToast(`Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ Ø¨Ù‡ '${levelNames[level]}' ØªØºÛŒÛŒØ± Ú©Ø±Ø¯`, 'info');
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²ÛŒ
        function updateGameInfo() {
            document.getElementById('current-turn').textContent = gameState.isWhiteTurn ? 'Ø³ÙÛŒØ¯' : 'Ø³ÛŒØ§Ù‡';
            document.getElementById('move-count').textContent = gameState.moves.length;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø­Ø±Ú©Ø§Øª
            const movesContainer = document.getElementById('moves-container');
            movesContainer.innerHTML = '';
            
            gameState.moves.forEach((move, index) => {
                const moveItem = document.createElement('div');
                moveItem.className = 'move-item';
                moveItem.innerHTML = `
                    <span>${index + 1}. ${move.move}</span>
                    <span>${move.player} (${move.eval ? move.eval.toFixed(1) : '?'})</span>
                `;
                movesContainer.appendChild(moveItem);
            });
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
            movesContainer.scrollTop = movesContainer.scrollHeight;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù†
            document.getElementById('update-time').textContent = new Date().toLocaleTimeString('fa-IR');
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ù…Ø³ØªÙ†Ø¯Ø§Øª API
        function showAPIDocs() {
            alert(`
ğŸ“– Ù…Ø³ØªÙ†Ø¯Ø§Øª API Ø´Ø·Ø±Ø¬Ø¯ TetraShop:

1. GET /api/status
   ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØªÙˆØ±

2. POST /api/game/new
   Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯
   Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§: {difficulty, playerName}

3. GET /api/engine/move
   Ø¯Ø±ÛŒØ§ÙØª Ø­Ø±Ú©Øª Ø§Ø² Ù…ÙˆØªÙˆØ±
   Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§: fen, level

4. POST /api/analyze
   ØªØ­Ù„ÛŒÙ„ Ù…ÙˆÙ‚Ø¹ÛŒØª
   Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§: {fen, depth}

5. POST /api/game/move
   Ø§Ù†Ø¬Ø§Ù… Ø­Ø±Ú©Øª Ø¯Ø± Ø¨Ø§Ø²ÛŒ
   Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§: {gameId, move}

Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§:
   /api/engine/move?fen=rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR&level=intermediate
   `);
        }
        
        // ØªØ³Øª Ù…ÙˆØªÙˆØ±
        async function testEngine() {
            try {
                const response = await fetch('/api/test/engine');
                const data = await response.json();
                
                if (data.success) {
                    showToast(`âœ… ØªØ³Øª Ù…ÙˆØªÙˆØ± Ù…ÙˆÙÙ‚: ${data.move} (Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ: ${data.evaluation})`, 'success');
                }
            } catch (error) {
                showError('Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ù…ÙˆØªÙˆØ±: ' + error.message);
            }
        }
        
        // ØªØ¨Ø¯ÛŒÙ„ Ø­Ø±Ú©Øª Ø¨Ù‡ UCI
        function moveToUCI(move) {
            const {from, to} = move;
            const colFrom = String.fromCharCode(97 + from.col);
            const rowFrom = 8 - from.row;
            const colTo = String.fromCharCode(97 + to.col);
            const rowTo = 8 - to.row;
            return `${colFrom}${rowFrom}${colTo}${rowTo}`;
        }
        
        // ØªØ¨Ø¯ÛŒÙ„ UCI Ø¨Ù‡ Ø­Ø±Ú©Øª
        function uciToMove(uci) {
            const colFrom = uci.charCodeAt(0) - 97;
            const rowFrom = 8 - parseInt(uci.charAt(1));
            const colTo = uci.charCodeAt(2) - 97;
            const rowTo = 8 - parseInt(uci.charAt(3));
            
            return {
                from: {row: rowFrom, col: colFrom},
                to: {row: rowTo, col: colTo}
            };
        }
        
        // ØªÙˆÙ„ÛŒØ¯ FEN
        function generateFEN() {
            let fen = '';
            
            for (let row = 0; row < 8; row++) {
                let empty = 0;
                
                for (let col = 0; col < 8; col++) {
                    const piece = gameState.board[row][col];
                    
                    if (piece === null) {
                        empty++;
                    } else {
                        if (empty > 0) {
                            fen += empty;
                            empty = 0;
                        }
                        fen += piece;
                    }
                }
                
                if (empty > 0) fen += empty;
                if (row < 7) fen += '/';
            }
            
            fen += gameState.isWhiteTurn ? ' w' : ' b';
            fen += ' KQkq - 0 1';
            
            return fen;
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ø®Ø§Ù†Ù‡
        function isValidSquare(row, col) {
            return row >= 0 && row < 8 && col >= 0 && col < 8;
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#36D1DC' : type === 'warning' ? '#FFD93D' : type === 'error' ? '#FF6B6B' : 'rgba(108, 99, 255, 0.9)'};
                color: ${type === 'warning' ? '#000' : '#fff'};
                padding: 12px 25px;
                border-radius: 10px;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                animation: fadeInOut 3s ease;
                text-align: center;
                max-width: 80%;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
        function showError(message) {
            showToast(`âŒ ${message}`, 'error');
        }
        
        // ÙØ±Ù…Øª Ø§Ø¹Ø¯Ø§Ø¯
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
